<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>手機版圖片裁切工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 禁止手機網頁下拉刷新，體驗更像 App */
        body { overscroll-behavior-y: none; background: #1a1a1a; }
        
        /* Cropper 自定義樣式 */
        .cropper-view-box, .cropper-face {
            border-radius: 0;
        }
        
        /* 隱藏滾動條但保持功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 輸入框聚焦時的樣式 */
        input:focus { border-color: #3b82f6; outline: none; }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row text-white overflow-hidden">

    <!-- 上半部：圖片預覽區 -->
    <div class="relative flex-1 bg-black flex justify-center items-center overflow-hidden z-0" id="canvasContainer">
        <!-- 未上傳時的引導 -->
        <div id="emptyState" class="text-center p-6">
            <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            </div>
            <p class="text-gray-400 mb-6">請選擇照片開始編輯</p>
            <button onclick="document.getElementById('fileInput').click()" class="bg-blue-600 active:bg-blue-700 px-8 py-3 rounded-full font-bold text-lg shadow-lg transition transform active:scale-95">
                選擇照片
            </button>
        </div>
        
        <!-- 圖片 (預設隱藏) -->
        <img id="image" class="max-w-full hidden">
    </div>

    <!-- 下半部：控制面板 (白色卡片) -->
    <!-- 手機：底部滑動卡片 / 電腦：右側側邊欄 -->
    <div id="controlsPanel" class="bg-white text-gray-800 flex flex-col z-10 
                w-full h-[50vh] rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.3)] transition-transform duration-300 translate-y-full
                md:w-[360px] md:h-full md:rounded-none md:translate-y-0 md:shadow-none">
        
        <!-- 頂部把手 (僅手機顯示) -->
        <div class="w-full h-6 flex justify-center items-center md:hidden shrink-0 cursor-grab">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
        </div>

        <!-- 滾動內容區 -->
        <div class="flex-1 overflow-y-auto p-5 space-y-5 no-scrollbar pb-24">
            
            <!-- 1. 常用尺寸按鈕 (橫向滾動) -->
            <div>
                <label class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 block">快速設定</label>
                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                    <button onclick="setRatio(1, '1:1 IG')" class="whitespace-nowrap px-4 py-2 bg-gray-100 rounded-lg text-sm font-medium hover:bg-blue-50 focus:bg-blue-100 focus:text-blue-600 border border-transparent focus:border-blue-300">正方形 1:1</button>
                    <button onclick="setRatio(1.777, '16:9 YT')" class="whitespace-nowrap px-4 py-2 bg-gray-100 rounded-lg text-sm font-medium hover:bg-blue-50 focus:bg-blue-100">16:9 寬螢幕</button>
                    <button onclick="setDims(192, 192)" class="whitespace-nowrap px-4 py-2 bg-gray-100 rounded-lg text-sm font-medium hover:bg-blue-50 focus:bg-blue-100">Icon 192</button>
                    <button onclick="setDims(1200, 630)" class="whitespace-nowrap px-4 py-2 bg-gray-100 rounded-lg text-sm font-medium hover:bg-blue-50 focus:bg-blue-100">FB 分享</button>
                    <button onclick="setRatio(NaN, '自由')" class="whitespace-nowrap px-4 py-2 bg-gray-100 rounded-lg text-sm font-medium hover:bg-blue-50 focus:bg-blue-100">自由裁切</button>
                </div>
            </div>

            <!-- 2. 詳細尺寸設定 -->
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2 flex justify-between items-center">
                    <label class="text-xs font-bold text-gray-500 uppercase">輸出尺寸 (PX)</label>
                    <button id="lockBtn" class="text-blue-500 text-sm flex items-center gap-1 bg-blue-50 px-2 py-1 rounded">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        <span>比例鎖定</span>
                    </button>
                </div>
                
                <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-bold">W</span>
                    <input type="number" id="widthInput" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 pl-8 pr-3 text-lg font-semibold text-center" placeholder="寬">
                </div>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-bold">H</span>
                    <input type="number" id="heightInput" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 pl-8 pr-3 text-lg font-semibold text-center" placeholder="高">
                </div>
            </div>

            <!-- 3. 旋轉與翻轉 -->
            <div>
                <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">調整</label>
                <div class="flex gap-2">
                    <button onclick="cropper.rotate(-90)" class="flex-1 py-3 bg-gray-100 rounded-xl hover:bg-gray-200">↺ 左轉</button>
                    <button onclick="cropper.rotate(90)" class="flex-1 py-3 bg-gray-100 rounded-xl hover:bg-gray-200">右轉 ↻</button>
                </div>
            </div>
            
             <!-- 4. 格式選擇 -->
            <div>
                 <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">存檔格式</label>
                 <div class="flex bg-gray-100 p-1 rounded-xl">
                     <button onclick="setFormat('png')" id="btn-png" class="flex-1 py-2 rounded-lg text-sm font-medium bg-white shadow-sm transition">PNG</button>
                     <button onclick="setFormat('jpg')" id="btn-jpg" class="flex-1 py-2 rounded-lg text-sm font-medium text-gray-500 hover:bg-white/50 transition">JPG</button>
                     <button onclick="setFormat('webp')" id="btn-webp" class="flex-1 py-2 rounded-lg text-sm font-medium text-gray-500 hover:bg-white/50 transition">WebP</button>
                 </div>
            </div>
        </div>

        <!-- 底部固定按鈕 -->
        <div class="p-4 border-t border-gray-100 bg-white md:bg-gray-50">
            <div class="flex gap-3">
                 <button onclick="document.getElementById('fileInput').click()" class="p-3 rounded-xl bg-gray-200 text-gray-600 md:hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                 </button>
                 <button id="downloadBtn" class="flex-1 bg-blue-600 active:bg-blue-700 text-white font-bold text-lg py-3 rounded-xl shadow-lg shadow-blue-200 transition transform active:scale-[0.98] flex justify-center items-center gap-2">
                    下載圖片
                </button>
            </div>
        </div>
    </div>

    <!-- 隱藏的 Input -->
    <input type="file" id="fileInput" accept="image/*" class="hidden">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        const fileInput = document.getElementById('fileInput');
        const image = document.getElementById('image');
        const emptyState = document.getElementById('emptyState');
        const controlsPanel = document.getElementById('controlsPanel');
        const widthInput = document.getElementById('widthInput');
        const heightInput = document.getElementById('heightInput');
        const lockBtn = document.getElementById('lockBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        let cropper;
        let isLocked = true;
        let exportFormat = 'image/png';
        let originalName = 'image';

        // 1. 上傳處理
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) initEditor(e.target.files[0]);
        });

        function initEditor(file) {
            originalName = file.name.split('.')[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                image.src = e.target.result;
                emptyState.classList.add('hidden');
                image.classList.remove('hidden');
                
                // 顯示控制面板 (手機上滑出來)
                controlsPanel.classList.remove('translate-y-full');
                
                if (cropper) cropper.destroy();
                
                cropper = new Cropper(image, {
                    viewMode: 1,
                    dragMode: 'move', // 手機上移動圖片比較直覺
                    autoCropArea: 0.8,
                    guides: true,
                    background: false, // 黑色背景比較好看
                    highlight: false,
                    responsive: true,
                    restore: false,
                    ready() {
                        updateInputs();
                    },
                    cropend() {
                        updateInputs(); // 觸控結束才更新數字，避免鍵盤跳出
                    },
                    zoom() {
                        // 縮放時不做事
                    }
                });
            };
            reader.readAsDataURL(file);
        }

        // 2. 輸入框邏輯
        function updateInputs() {
            if (!cropper) return;
            const data = cropper.getData();
            widthInput.value = Math.round(data.width);
            heightInput.value = Math.round(data.height);
        }

        widthInput.addEventListener('change', function() {
            if (!cropper) return;
            const w = parseInt(this.value);
            let h = heightInput.value;
            if (isLocked) {
                const data = cropper.getData();
                h = w / (data.width / data.height);
                heightInput.value = Math.round(h);
            }
            cropper.setData({ width: w, height: parseFloat(h) });
        });

        heightInput.addEventListener('change', function() {
            if (!cropper) return;
            const h = parseInt(this.value);
            let w = widthInput.value;
            if (isLocked) {
                const data = cropper.getData();
                w = h * (data.width / data.height);
                widthInput.value = Math.round(w);
            }
            cropper.setData({ width: parseFloat(w), height: h });
        });

        // 3. 按鈕功能
        lockBtn.addEventListener('click', () => {
            isLocked = !isLocked;
            lockBtn.classList.toggle('bg-blue-50');
            lockBtn.classList.toggle('bg-gray-100');
            lockBtn.classList.toggle('text-blue-500');
            lockBtn.classList.toggle('text-gray-500');
            lockBtn.querySelector('span').textContent = isLocked ? "比例鎖定" : "比例解鎖";
        });

        window.setRatio = function(ratio, text) {
            if (!cropper) return;
            cropper.setAspectRatio(ratio);
            // 解鎖以便調整，或者保持鎖定視需求而定
        }

        window.setDims = function(w, h) {
            if (!cropper) return;
            cropper.setAspectRatio(NaN); // 解除強制比例
            cropper.setData({ width: w, height: h });
            updateInputs();
        }

        window.setFormat = function(fmt) {
            exportFormat = `image/${fmt}`;
            document.querySelectorAll('[id^="btn-"]').forEach(btn => {
                btn.className = 'flex-1 py-2 rounded-lg text-sm font-medium text-gray-500 hover:bg-white/50 transition';
            });
            const activeBtn = document.getElementById(`btn-${fmt}`);
            activeBtn.className = 'flex-1 py-2 rounded-lg text-sm font-medium bg-white shadow-sm transition text-blue-600';
        }

        // 4. 下載
        downloadBtn.addEventListener('click', () => {
            if (!cropper) return;
            const canvas = cropper.getCroppedCanvas({
                width: parseInt(widthInput.value),
                height: parseInt(heightInput.value),
                imageSmoothingQuality: 'high'
            });
            
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const ext = exportFormat.split('/')[1];
                a.download = `${originalName}_edited.${ext}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }, exportFormat, 0.9);
        });

        // 處理手機鍵盤彈出時的畫面高度調整 (防止 UI 被遮擋)
        const initialHeight = window.innerHeight;
        window.addEventListener('resize', () => {
            if (window.innerHeight < initialHeight) {
                // 鍵盤彈出
                controlsPanel.classList.add('h-full');
            } else {
                controlsPanel.classList.remove('h-full');
            }
        });

    </script>
</body>
</html>